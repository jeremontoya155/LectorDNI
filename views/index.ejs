<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>DNI Scanner</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <!-- Alerta de capacidad m√°xima -->
        <div class="capacidad-alerta" id="capacidadAlerta" style="display: none;">
            <div class="alerta-content">
                <span class="alerta-icon">üö®</span>
                <span class="alerta-text">¬°CAPACIDAD M√ÅXIMA ALCANZADA!</span>
                <button class="btn-descargar" id="descargarAlertaBtn">üì• Descargar Datos</button>
            </div>
        </div>

        <header>
            <div class="header-left">
                <h1>‚ö° DNI Scanner</h1>
            </div>
            <div class="contadores-wrapper">
                <div class="contador contador-mayores">
                    <span class="contador-numero" id="contadorMayores"><%= contadorMayores %></span>
                    <span class="contador-label">Dentro</span>
                </div>
                <div class="contador contador-salidas">
                    <span class="contador-numero" id="contadorSalidas"><%= contadorSalidas %></span>
                    <span class="contador-label">Salidas</span>
                </div>
                <div class="contador contador-menores">
                    <span class="contador-numero" id="contadorMenores"><%= contadorMenores %></span>
                    <span class="contador-label">Menores</span>
                </div>
                <div class="contador contador-total">
                    <span class="contador-numero" id="contadorTotal"><%= contador %></span>
                    <span class="contador-label">Total</span>
                </div>
                <div class="contador contador-capacidad" id="contadorCapacidad" style="display: none;">
                    <span class="contador-numero" id="capacidadActual">0</span>
                    <span class="contador-label">/ <span id="capacidadMaxima">‚àû</span></span>
                </div>
            </div>
            <div class="header-actions">
                <button id="entradaManualBtn" class="btn-entrada" style="display: none;">üö™ Entrada</button>
                <button id="salidaBtn" class="btn-salida">üö™ Salida</button>
                <button id="resetCountersBtn" class="btn-reset">üîÑ Reset</button>
                <button id="menuBtn" class="btn-menu">‚ò∞</button>
            </div>
        </header>

        <!-- Men√∫ Hamburguesa de Configuraci√≥n -->
        <div class="menu-overlay" id="menuOverlay"></div>
        <div class="menu-sidebar" id="menuSidebar">
            <div class="menu-header">
                <h2>‚öôÔ∏è Configuraci√≥n</h2>
                <button class="menu-close" id="menuClose">‚úï</button>
            </div>
            
            <div class="menu-content">
                <!-- Modo de escaneo -->
                <div class="config-section">
                    <h3>üì± Modo de Escaneo</h3>
                    <div class="config-option">
                        <label class="radio-label">
                            <input type="radio" name="modoEscaneo" value="camera" id="configModoCamera" checked>
                            <span class="radio-custom"></span>
                            <span class="radio-text">üì∑ C√°mara</span>
                        </label>
                        <p class="config-desc">Usar la c√°mara del dispositivo para escanear</p>
                    </div>
                    <div class="config-option">
                        <label class="radio-label">
                            <input type="radio" name="modoEscaneo" value="scanner" id="configModoScanner">
                            <span class="radio-custom"></span>
                            <span class="radio-text">üî´ Lector F√≠sico</span>
                        </label>
                        <p class="config-desc">Usar pistola lectora o colector de datos</p>
                    </div>
                </div>

                <!-- Capacidad m√°xima -->
                <div class="config-section">
                    <h3>üë• Capacidad M√°xima</h3>
                    <div class="config-option">
                        <label class="toggle-label">
                            <input type="checkbox" id="habilitarCapacidad">
                            <span class="toggle-switch"></span>
                            <span>Habilitar l√≠mite de capacidad</span>
                        </label>
                    </div>
                    <div class="capacidad-input-wrapper" id="capacidadInputWrapper" style="display: none;">
                        <label>Capacidad m√°xima de personas:</label>
                        <input type="number" id="capacidadMaximaInput" min="1" max="99999" value="5000" class="config-input">
                        <button class="btn-guardar-capacidad" id="guardarCapacidadBtn">üíæ Guardar</button>
                    </div>
                </div>

                <!-- Ingreso sin DNI -->
                <div class="config-section">
                    <h3>üü¢ Entrada Manual</h3>
                    <div class="config-option">
                        <label class="toggle-label">
                            <input type="checkbox" id="permitirIngresoSinDni">
                            <span class="toggle-switch"></span>
                            <span>Permitir ingreso sin DNI</span>
                        </label>
                        <p class="config-desc">Muestra un bot√≥n para registrar entradas manualmente sin escanear</p>
                    </div>
                </div>

                <!-- Datos y Cache -->
                <div class="config-section">
                    <h3>üíæ Datos Guardados</h3>
                    <div class="cache-info">
                        <p>üìä Escaneos en cach√©: <strong id="cacheCount">0</strong></p>
                        <p>üìÖ √öltima sesi√≥n: <strong id="lastSession">-</strong></p>
                    </div>
                    <div class="config-buttons">
                        <button class="btn-config" id="descargarDatosBtn">üì• Descargar Datos</button>
                        <button class="btn-config" id="verHistorialBtn">üìã Ver Historial Completo</button>
                        <button class="btn-config btn-danger" id="limpiarCacheBtn">üóëÔ∏è Limpiar Cach√©</button>
                    </div>
                </div>

                <!-- Info -->
                <div class="config-section config-info">
                    <p>üí° Los datos se guardan autom√°ticamente en tu dispositivo</p>
                </div>
            </div>
        </div>

        <main>
            <!-- Indicador de modo de escaneo (compacto) -->
            <div class="scan-mode-indicator" id="scanModeIndicator">
                <div class="mode-badge" id="modeBadge">
                    <span id="modeIcon">üì∑</span>
                    <span id="modeText">C√°mara</span>
                </div>
                <div class="device-status" id="deviceStatus">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Detectando dispositivo...</span>
                </div>
            </div>

            <!-- Secci√≥n de escaneo -->
            <div class="scan-section" id="scanSection">
                <!-- Modo C√°mara -->
                <div class="camera-container" id="cameraContainer">
                    <video id="video" autoplay playsinline></video>
                    <div class="scan-overlay">
                        <div class="scan-frame">
                            <div class="corner corner-tl"></div>
                            <div class="corner corner-tr"></div>
                            <div class="corner corner-bl"></div>
                            <div class="corner corner-br"></div>
                            <div class="scan-line"></div>
                        </div>
                    </div>
                    <canvas id="canvas" style="display: none;"></canvas>
                </div>

                <!-- Modo Lector F√≠sico (Pistola/Colector) -->
                <div class="scanner-mode-container" id="scannerModeContainer" style="display: none;">
                    <div class="scanner-icon">
                        <div class="scanner-pulse"></div>
                        üî´
                    </div>
                    <h3>Modo Lector F√≠sico Activo</h3>
                    <p class="scanner-instruction">Escanea el c√≥digo de barras del DNI con tu pistola o colector</p>
                    <div class="scanner-input-wrapper">
                        <input type="text" id="barcodeInput" class="barcode-input" 
                               placeholder="El c√≥digo aparecer√° aqu√≠..." 
                               autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                        <div class="input-indicator" id="inputIndicator">‚å®Ô∏è Esperando entrada...</div>
                    </div>
                    <div class="scanner-tips">
                        <p>üí° <strong>Tips:</strong></p>
                        <ul>
                            <li>El lector debe estar configurado para enviar ENTER al final</li>
                            <li>Tambi√©n funciona con pistolas USB conectadas a PC</li>
                            <li>El escaneo es autom√°tico al detectar el c√≥digo</li>
                        </ul>
                    </div>
                </div>

                <div class="controls">
                    <button id="startBtn" class="btn btn-primary">
                        üì∑ Iniciar C√°mara
                    </button>
                    <button id="stopBtn" class="btn btn-danger" style="display: none;">
                        ‚èπÔ∏è Detener
                    </button>
                </div>

                <div class="instructions" id="cameraInstructions">
                    <p>üìå Posiciona el c√≥digo de barras del DNI dentro del marco</p>
                </div>
            </div>

            <!-- Secci√≥n de resultados -->
            <div class="result-section" id="resultSection" style="display: none;">
                <div class="result-card" id="resultCard">
                    <div class="status-badge" id="statusBadge">
                        <!-- Se actualiza din√°micamente -->
                    </div>

                    <div class="auto-scan-notice">
                        <span class="auto-scan-icon">‚è±Ô∏è</span>
                        <span>Siguiente en <strong id="autoScanTimer">3</strong>s</span>
                        <button id="quickScanBtn" class="btn btn-primary" style="padding: 8px 16px; font-size: 0.85em;">
                            ‚ö° Ahora
                        </button>
                    </div>
                    
                    <div class="result-content">
                        <div class="datos-sections">
                            <div class="datos-section">
                                <h3 class="section-title">üë§ Persona</h3>
                                <div class="person-info">
                                    <div class="info-row">
                                        <span class="info-label">Nombre</span>
                                        <span class="info-value" id="nombreCompleto"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">DNI</span>
                                        <span class="info-value" id="dniNumero"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Edad</span>
                                        <span class="info-value" id="edadPersona"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Sexo</span>
                                        <span class="info-value" id="sexo"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Nacimiento</span>
                                        <span class="info-value" id="fechaNacimiento"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="datos-section">
                                <h3 class="section-title">üìÑ Documento</h3>
                                <div class="person-info">
                                    <div class="info-row">
                                        <span class="info-label">CUIL</span>
                                        <span class="info-value" id="cuil"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Tr√°mite</span>
                                        <span class="info-value" id="tramite"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Ejemplar</span>
                                        <span class="info-value" id="ejemplar"></span>
                                    </div>
                                    <div class="info-row">
                                        <span class="info-label">Vencimiento</span>
                                        <span class="info-value" id="fechaVencimiento"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden fields for compatibility -->
                    <span id="nacionalidad" style="display:none;"></span>
                    <span id="lugarNacimiento" style="display:none;"></span>
                    <span id="paisNacimiento" style="display:none;"></span>
                    <span id="fechaEmision" style="display:none;"></span>
                    <div id="paisRow" style="display:none;"></div>
                </div>
            </div>

            <!-- Historial -->
            <div class="historial-section">
                <h3>üìã √öltimos Escaneos</h3>
                <div class="historial-list" id="historialList">
                    <% if (historial.length === 0) { %>
                        <p class="no-data">Sin escaneos a√∫n</p>
                    <% } else { %>
                        <% historial.forEach(function(item) { %>
                            <div class="historial-item <%= item.esMayorDeEdad ? 'mayor' : 'menor' %>">
                                <div class="historial-info">
                                    <strong><%= item.nombre %> <%= item.apellido %></strong>
                                    <span>DNI: <%= item.dni %> ‚Ä¢ <%= item.edad %> a√±os</span>
                                </div>
                                <div class="historial-badge">
                                    <%= item.esMayorDeEdad ? '‚úì +18' : '‚ö† -18' %>
                                </div>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>
    <script src="/js/scanner.js"></script>
</body>
</html>
